<?php
/**
 * @var \Rollpix\GoogleOneTap\Block\Customer\Account\GoogleLinkedNotice $block
 * @var \Magento\Framework\Escaper $escaper
 */

use Magento\Framework\Escaper;
use Rollpix\GoogleOneTap\Block\Customer\Account\GoogleLinkedNotice;

// Only show for logged in customers
if (!$block->isCustomerLoggedIn()) {
    return;
}

// Only show for accounts linked with Google One Tap (created or linked)
if (!$block->isGoogleOneTapLinked()) {
    return;
}

$googleEmail = $escaper->escapeHtml($block->getGoogleEmail());
$isCreatedWithGoogle = $block->isGoogleOneTapCreated();
?>

<!-- Google One Tap Account Notice -->
<div class="message info google-onetap-notice" style="margin-bottom: 20px;">
    <div>
        <?= $escaper->escapeHtml(__('Your Librería Oxford account is linked with your Google account %1', $googleEmail)) ?>
    </div>
</div>

<?php if ($isCreatedWithGoogle): ?>
    <!-- Hide change password checkbox and fieldset for Google One Tap created accounts -->
    <style>
        /* Hide any field containing "change-password" in class or name */
        .field.choice.change-password,
        .field.change-password,
        [name="change_password"],
        input[type="checkbox"][value*="password"],
        label[for*="change-password"],
        label[for*="change_password"] {
            display: none !important;
        }

        /* Hide password fieldset */
        .fieldset.password,
        fieldset.password,
        .form-edit-account .fieldset.password {
            display: none !important;
        }

        /* Hide containing divs */
        .box-information .field.choice:has(input[name="change_password"]) {
            display: none !important;
        }
    </style>

    <script>
        require(['jquery'], function($) {
            $(document).ready(function() {
                console.log('Google One Tap: Hiding password change options for Google-created account');

                // Method 1: Hide by checkbox value/name containing password
                $('input[type="checkbox"]').each(function() {
                    const $checkbox = $(this);
                    const name = $checkbox.attr('name') || '';
                    const id = $checkbox.attr('id') || '';
                    const value = $checkbox.val() || '';

                    if (name.toLowerCase().includes('password') ||
                        id.toLowerCase().includes('password') ||
                        value.toString().toLowerCase().includes('password')) {
                        // Hide the checkbox and its parent field
                        $checkbox.closest('.field').hide();
                        console.log('Hid password checkbox:', name, id);
                    }
                });

                // Method 2: Hide by label text containing "contraseña" or "password"
                $('label').each(function() {
                    const labelText = $(this).text().toLowerCase();
                    if (labelText.includes('contraseña') || labelText.includes('password')) {
                        $(this).closest('.field.choice').hide();
                        console.log('Hid by label text:', $(this).text());
                    }
                });

                // Method 3: Hide password fieldset
                $('.fieldset.password, fieldset.password').hide();

                // Method 4: Target by common Magento structure
                $('.box-information .field.choice').each(function() {
                    const fieldHtml = $(this).html().toLowerCase();
                    if (fieldHtml.includes('password') || fieldHtml.includes('contraseña')) {
                        $(this).hide();
                        console.log('Hid password field by HTML content');
                    }
                });
            });
        });
    </script>
<?php endif; ?>
