<?php
/**
 * @var OneTap $block
 * @var Escaper $escaper
 */

use Rollpix\GoogleOneTap\Block\OneTap;
use Magento\Framework\Escaper;

if (!$block->isCustomerLoggedIn() && $block->isEnable()) :
    $clientId = $escaper->escapeHtml($block->getClientId());
    $loginUri = $escaper->escapeUrl($block->getUrl('customer/account'));
    $callbackUrl = $escaper->escapeUrl($block->getUrl('onetaplogin/checkout/response'));
    $positionClass = $escaper->escapeHtml($block->getPosition());

    $autoSign = $block->getAutoSign() ? 'data-auto_select="true"' : '';
    $cancelOnTapOutside = (!$block->getClickDisable() && !$block->getAutoSign())
        ? 'data-cancel_on_tap_outside="false"'
        : '';
    ?>
    <!-- Google One Tap Container -->
    <div id="g_id_onload"
         data-client_id="<?= $clientId ?>"
         data-context="signin"
         data-callback="googleLoginEndpoint"
         data-login_uri="<?= $loginUri ?>"
         data-itp_support="true"
        <?= $autoSign ?>
        <?= $cancelOnTapOutside ?>>
    </div>

    <!-- Google One Tap Callback Script -->
    <script>
        function googleLoginEndpoint(googleUser) {
            console.log('Google One Tap callback triggered', googleUser);
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "<?= $callbackUrl ?>", true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.success) {
                                console.log('Google One Tap: Login successful, reloading customer data...');
                                require(['Magento_Customer/js/customer-data'], function(customerData) {
                                    // Invalidate customer and cart sections to force reload
                                    customerData.invalidate(['customer', 'cart']);
                                    customerData.reload(['customer', 'cart'], true);

                                    // Give session time to persist, then reload page
                                    setTimeout(function() {
                                        console.log('Google One Tap: Reloading page...');
                                        window.location.reload();
                                    }, 500);
                                });
                            } else {
                                console.error('Google One Tap login failed:', response.message || 'Unknown error');
                            }
                        } catch (e) {
                            console.error('Invalid response from Google One Tap endpoint:', e);
                        }
                    } else {
                        console.error('Google One Tap network error. Status:', xhr.status);
                    }
                }
            };

            const params = "id_token=" + encodeURIComponent(googleUser.credential);
            console.log('Sending params:', params);
            console.log('URL:', "<?= $callbackUrl ?>");
            xhr.send(params);
        }
    </script>

    <!-- Add Position Class to Google Picker Container -->
    <script>
        require(['jquery'], function ($) {
            $(function () {
                let attempts = 0;
                const maxAttempts = 50; // 5 seconds maximum (50 * 100ms)

                const interval = setInterval(function () {
                    const container = $('#credential_picker_container');
                    attempts++;

                    if (container.length) {
                        container.addClass("<?= $positionClass ?>");
                        clearInterval(interval);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(interval);
                        console.warn('Google One Tap container not found after 5 seconds');
                    }
                }, 100);
            });
        });
    </script>
<?php endif; ?>
