<?php
/**
 * @var GoogleSignInButton $block
 * @var Escaper $escaper
 */

use Rollpix\GoogleOneTap\Block\GoogleSignInButton;
use Magento\Framework\Escaper;

if ($block->shouldRender()) :
    $clientId = $escaper->escapeJs($block->getClientId());
    $callbackUrl = $escaper->escapeUrl($block->getCallbackUrl());
    $buttonConfig = /* @noEscape */ $block->getButtonConfigJson();
    $customSelector = $escaper->escapeJs($block->getButtonCustomSelector());
    $pageType = $escaper->escapeJs($block->getData('page_type') ?: '');
    $position = $escaper->escapeJs($block->getButtonPosition());
    $wrapperId = 'rollpix-social-login-' . ($block->getData('page_type') ?: 'default');
    $buttonId = 'rollpix-google-signin-button-' . ($block->getData('page_type') ?: 'default');
    ?>

    <!-- Google Sign-In Button wrapper (relocated via JS based on position config) -->
    <div id="<?= $escaper->escapeHtmlAttr($wrapperId) ?>"
         class="rollpix-social-login-wrapper"
         style="display:none">
        <div class="rollpix-social-login-divider">
            <span><?= $escaper->escapeHtml(__('Or')) ?></span>
        </div>
        <div id="<?= $escaper->escapeHtmlAttr($buttonId) ?>" class="rollpix-social-login-button"></div>
    </div>

    <script>
        (function() {
            var wrapperId = '<?= $escaper->escapeJs($wrapperId) ?>';
            var buttonId = '<?= $escaper->escapeJs($buttonId) ?>';
            var pageType = '<?= $pageType ?>';
            var position = '<?= $position ?>';
            var relocated = false;
            var buttonRendered = false;

            // ── Helper: flip divider/button order for "above" positions ───
            function applyDividerOrder(wrapper, pos) {
                if (pos === 'above') {
                    wrapper.classList.add('rollpix-position-above');
                }
            }

            // ── Helper: hide the "Or" divider ────────────────────────────
            function hideDivider(wrapper) {
                var divider = wrapper.querySelector('.rollpix-social-login-divider');
                if (divider) divider.style.display = 'none';
            }

            // ── Relocation: Login page ───────────────────────────────────

            function relocateLogin(wrapper, pos) {
                var loginBlock = document.querySelector('.block-customer-login .block-content');
                if (!loginBlock) return false;

                if (pos === 'above') {
                    var form = loginBlock.querySelector('form.form-login');
                    if (form) {
                        loginBlock.insertBefore(wrapper, form);
                    } else {
                        loginBlock.insertBefore(wrapper, loginBlock.firstChild);
                    }
                } else {
                    // 'below' (default) - append at end of login block
                    loginBlock.appendChild(wrapper);
                }
                applyDividerOrder(wrapper, pos);
                wrapper.style.display = '';
                return true;
            }

            // ── Relocation: Registration page ────────────────────────────

            function relocateRegister(wrapper, pos) {
                var form = document.querySelector('form.form-create-account');
                if (!form) return false;

                if (pos === 'above') {
                    form.parentNode.insertBefore(wrapper, form);
                    applyDividerOrder(wrapper, pos);
                    wrapper.style.display = '';
                } else if (pos === 'side') {
                    // Create flex wrapper around the form with a side column
                    if (!document.querySelector('.rollpix-register-flex-wrapper')) {
                        var parent = form.parentNode;
                        var flexWrapper = document.createElement('div');
                        flexWrapper.className = 'rollpix-register-flex-wrapper';
                        // Inline styles as fallback to guarantee flex behavior
                        flexWrapper.style.cssText = 'display:flex!important;gap:30px;align-items:flex-start;width:100%';

                        parent.insertBefore(flexWrapper, form);
                        flexWrapper.appendChild(form);

                        // Ensure form fills available space
                        form.style.cssText = (form.style.cssText || '') + ';flex:1;min-width:0;max-width:none!important;width:auto!important';

                        var sideCol = document.createElement('div');
                        sideCol.className = 'rollpix-register-side-column';
                        sideCol.style.cssText = 'width:280px;min-width:280px;flex-shrink:0;position:sticky;top:20px';

                        var card = document.createElement('div');
                        card.className = 'rollpix-register-side-card';

                        var title = document.createElement('p');
                        title.className = 'rollpix-register-side-title';
                        title.textContent = '<?= $escaper->escapeJs(__('Quick sign up with your Google account')) ?>';
                        card.appendChild(title);

                        hideDivider(wrapper);
                        card.appendChild(wrapper);
                        sideCol.appendChild(card);
                        flexWrapper.appendChild(sideCol);
                    }
                    wrapper.style.display = '';
                } else {
                    // 'below' (default)
                    if (form.nextSibling) {
                        form.parentNode.insertBefore(wrapper, form.nextSibling);
                    } else {
                        form.parentNode.appendChild(wrapper);
                    }
                    wrapper.style.display = '';
                }
                return true;
            }

            // ── Relocation: Checkout page ────────────────────────────────

            function relocateCheckout(wrapper, pos) {
                if (pos === 'below') {
                    return relocateCheckoutBelow(wrapper);
                }
                // 'left' or 'right' - try inline, fallback to below
                return relocateCheckoutInline(wrapper, pos) || relocateCheckoutBelow(wrapper);
            }

            function relocateCheckoutBelow(wrapper) {
                var target = document.querySelector('[data-role="email-with-possible-login"]')
                          || document.querySelector('#customer-email-fieldset')
                          || document.querySelector('.am-opc-login-wrapper')
                          || document.querySelector('.authentication-wrapper')
                          || document.querySelector('.opc-wrapper .step-title');
                if (!target) return false;

                wrapper.classList.add('rollpix-checkout-below');
                if (target.nextSibling) {
                    target.parentNode.insertBefore(wrapper, target.nextSibling);
                } else {
                    target.parentNode.appendChild(wrapper);
                }
                wrapper.style.display = '';
                return true;
            }

            function relocateCheckoutInline(wrapper, pos) {
                // Strategy 1: Native checkout - place next to the "Sign In" toggle button
                var authWrapper = document.querySelector('.authentication-wrapper');
                if (authWrapper) {
                    var toggleBtn = authWrapper.querySelector('.action-auth-toggle');
                    if (toggleBtn) {
                        hideDivider(wrapper);
                        wrapper.classList.add('rollpix-checkout-inline');
                        authWrapper.classList.add('rollpix-has-google-btn');

                        // Find the popup element to insert before it (keep popup as last child)
                        var popup = authWrapper.querySelector('.block-authentication');

                        if (pos === 'left') {
                            authWrapper.insertBefore(wrapper, toggleBtn);
                        } else {
                            // 'right' - insert after toggle, before popup
                            if (popup) {
                                authWrapper.insertBefore(wrapper, popup);
                            } else if (toggleBtn.nextSibling) {
                                authWrapper.insertBefore(wrapper, toggleBtn.nextSibling);
                            } else {
                                authWrapper.appendChild(wrapper);
                            }
                        }
                        wrapper.style.display = '';
                        return true;
                    }
                }

                // Strategy 2: Amasty/other checkout with visible login form
                var loginForms = document.querySelectorAll('.form-login');
                for (var i = 0; i < loginForms.length; i++) {
                    var loginForm = loginForms[i];
                    // Only target visible forms (not inside hidden popups)
                    if (loginForm.offsetParent !== null) {
                        var toolbar = loginForm.querySelector('.actions-toolbar');
                        if (toolbar) {
                            hideDivider(wrapper);
                            wrapper.classList.add('rollpix-checkout-inline');
                            toolbar.classList.add('rollpix-checkout-flex');

                            if (pos === 'left') {
                                toolbar.insertBefore(wrapper, toolbar.firstChild);
                            } else {
                                toolbar.appendChild(wrapper);
                            }
                            wrapper.style.display = '';
                            return true;
                        }
                    }
                }

                return false;
            }

            // ── Main relocation dispatcher ──────────────────────────────

            function relocateWrapper() {
                var wrapper = document.getElementById(wrapperId);
                if (!wrapper) return false;

                if (pageType === 'login') {
                    return relocateLogin(wrapper, position);
                } else if (pageType === 'register') {
                    return relocateRegister(wrapper, position);
                } else if (pageType === 'checkout') {
                    return relocateCheckout(wrapper, position);
                }

                // Unknown page type - just show in place
                wrapper.style.display = '';
                return true;
            }

            // ── Google Sign-In Button rendering ─────────────────────────

            function initGoogleButton() {
                if (buttonRendered) return true;
                if (typeof google === 'undefined' || !google.accounts || !google.accounts.id) return false;

                // Ensure the shared namespace and callback exist
                window.RollpixSocialLogin = window.RollpixSocialLogin || {};

                if (!window.RollpixSocialLogin.googleCallback) {
                    // Callback not yet defined by onetap.phtml (One Tap may be disabled)
                    window.RollpixSocialLogin.callbackUrl = window.RollpixSocialLogin.callbackUrl || "<?= $callbackUrl ?>";

                    window.RollpixSocialLogin.showErrorMessage = window.RollpixSocialLogin.showErrorMessage || function(message) {
                        require(['Magento_Ui/js/model/messageList', 'jquery'], function(messageList, $) {
                            messageList.addErrorMessage({ message: message });
                            $('html, body').animate({ scrollTop: $('.page.messages').offset()?.top || 0 }, 500);
                        });
                    };

                    window.RollpixSocialLogin.handleLoginSuccess = window.RollpixSocialLogin.handleLoginSuccess || function() {
                        require(['Magento_Customer/js/customer-data', 'jquery'], function(customerData, $) {
                            var loaded = false;
                            var timeout;
                            var listener = function() {
                                var customer = customerData.get('customer')();
                                if (customer && customer.firstname) {
                                    loaded = true;
                                    clearTimeout(timeout);
                                    $(document).off('customer-data-reload', listener);
                                    window.location.reload();
                                }
                            };
                            $(document).on('customer-data-reload', listener);
                            customerData.get('customer').subscribe(listener);
                            customerData.invalidate(['customer', 'cart']);
                            customerData.reload(['customer', 'cart'], true);
                            timeout = setTimeout(function() {
                                if (!loaded) {
                                    $(document).off('customer-data-reload', listener);
                                    window.location.reload();
                                }
                            }, 1000);
                        });
                    };

                    window.RollpixSocialLogin.googleCallback = function(googleUser) {
                        var xhr = new XMLHttpRequest();
                        xhr.open("POST", window.RollpixSocialLogin.callbackUrl, true);
                        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                        xhr.onreadystatechange = function() {
                            if (xhr.readyState === 4) {
                                if (xhr.status === 200) {
                                    try {
                                        var response = JSON.parse(xhr.responseText);
                                        if (response.success) {
                                            window.RollpixSocialLogin.handleLoginSuccess();
                                        } else {
                                            window.RollpixSocialLogin.showErrorMessage(
                                                response.message || '<?= $escaper->escapeJs(__('Authentication failed. Please try again.')) ?>'
                                            );
                                        }
                                    } catch (e) {
                                        window.RollpixSocialLogin.showErrorMessage(
                                            '<?= $escaper->escapeJs(__('An unexpected error occurred. Please try again.')) ?>'
                                        );
                                    }
                                } else {
                                    window.RollpixSocialLogin.showErrorMessage(
                                        '<?= $escaper->escapeJs(__('Network error. Please check your connection and try again.')) ?>'
                                    );
                                }
                            }
                        };
                        xhr.send("id_token=" + encodeURIComponent(googleUser.credential));
                    };
                }

                // Initialize Google Sign-In (safe to call multiple times - GSI handles it)
                google.accounts.id.initialize({
                    client_id: "<?= $clientId ?>",
                    callback: window.RollpixSocialLogin.googleCallback
                });

                // Render button in the wrapper container
                var container = document.getElementById(buttonId);
                if (container) {
                    var btnConfig = <?= $buttonConfig ?>;
                    google.accounts.id.renderButton(container, btnConfig);
                }

                <?php if (!empty($customSelector)): ?>
                // Render in custom selector container
                var customContainer = document.querySelector("<?= $customSelector ?>");
                if (customContainer && !document.getElementById('rollpix-google-signin-button-custom')) {
                    var cloneDiv = document.createElement('div');
                    cloneDiv.id = 'rollpix-google-signin-button-custom';
                    cloneDiv.className = 'rollpix-social-login-button';
                    customContainer.appendChild(cloneDiv);
                    google.accounts.id.renderButton(cloneDiv, <?= $buttonConfig ?>);
                }
                <?php endif; ?>

                buttonRendered = true;
                return true;
            }

            // ── Initialization with polling ─────────────────────────────

            function tryInit() {
                if (!relocated) {
                    relocated = relocateWrapper();
                }
                if (relocated && !buttonRendered) {
                    initGoogleButton();
                }
                return relocated && buttonRendered;
            }

            function startInit() {
                if (tryInit()) return;

                var attempts = 0;
                var maxAttempts = 80; // 8 seconds (80 * 100ms)
                var interval = setInterval(function() {
                    attempts++;
                    if (tryInit() || attempts >= maxAttempts) {
                        clearInterval(interval);
                    }
                }, 100);
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', startInit);
            } else {
                startInit();
            }
        })();
    </script>
<?php endif; ?>
